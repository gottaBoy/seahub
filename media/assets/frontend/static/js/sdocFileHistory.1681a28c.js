"use strict";(self.webpackChunkseahub_frontend=self.webpackChunkseahub_frontend||[]).push([[514],{67145:function(e,n,t){var i=t(15671),s=t(43144),o=t(60136),r=t(29388),a=t(72791),c=t(53585),l=t(95996),h=t(51832),d=t(80184),u=function(e){(0,o.Z)(t,e);var n=(0,r.Z)(t);function t(e){var s;return(0,i.Z)(this,t),(s=n.call(this,e)).onClick=function(e){s.inputRef.current.contains(e.target)||s.onRenameConfirm()},s.onChange=function(e){s.setState({name:e.target.value})},s.onKeyDown=function(e){e.keyCode===l.c.keyCodes.enter?s.onRenameConfirm(e):e.keyCode===l.c.keyCodes.esc&&s.onRenameCancel(e),e.nativeEvent.stopImmediatePropagation()},s.onRenameConfirm=function(e){e&&e.nativeEvent.stopImmediatePropagation();var n=s.state.name.trim();if(n!==s.props.name){var t=s.validateInput(),i=t.isValid,o=t.errMessage;i?s.props.onRenameConfirm(n):(h.Z.danger(o),s.props.onRenameCancel())}else s.props.onRenameCancel()},s.onRenameCancel=function(e){e.nativeEvent.stopImmediatePropagation(),s.props.onRenameCancel()},s.validateInput=function(){var e=s.state.name.trim(),n=!0,t="";return e?e.indexOf("/")>-1?{isValid:n=!1,errMessage:t=(0,c.ih)("Name should not include '/'.")}:{isValid:n,errMessage:t}:{isValid:n=!1,errMessage:t=(0,c.ih)("Name is required.")}},s.state={name:e.name},s.inputRef=a.createRef(),s}return(0,s.Z)(t,[{key:"componentDidMount",value:function(){var e=this;if(this.inputRef.current.focus(),this.props.hasSuffix){var n=this.props.name.lastIndexOf(".");this.inputRef.current.setSelectionRange(0,n,"forward")}else this.inputRef.current.setSelectionRange(0,-1);setTimeout((function(){document.addEventListener("click",e.onClick)}),1)}},{key:"componentWillUnmount",value:function(){document.removeEventListener("click",this.onClick)}},{key:"render",value:function(){return(0,d.jsx)("div",{className:"rename-container",children:(0,d.jsx)("input",{ref:this.inputRef,value:this.state.name,onChange:this.onChange,onKeyDown:this.onKeyDown})})}}]),t}(a.Component);n.Z=u},39321:function(e,n,t){var i=t(15671),s=t(43144),o=t(60136),r=t(29388),a=t(72791),c=t(54164),l=t(98290),h=t(81694),d=t.n(h),u=t(32775),f=t(22228),m=t(53585),g=t(63446),p=t(80184),v=function(e){(0,o.Z)(t,e);var n=(0,r.Z)(t);function t(){var e;(0,i.Z)(this,t);for(var s=arguments.length,o=new Array(s),r=0;r<s;r++)o[r]=arguments[r];return(e=n.call.apply(n,[this].concat(o))).onBackClick=function(e){e.preventDefault(),window.history.back()},e}return(0,s.Z)(t,[{key:"render",value:function(){return(0,p.jsx)("div",{className:"go-back",onClick:this.onBackClick,children:(0,p.jsx)("span",{className:"fas fa-chevron-left"})})}}]),t}(a.Component),y=v,x=t(93433),C=t(95996),S=t(39571),w=t(51832),j=t(72426),V=t.n(j),R=t(61599),Z=t(20387),N=t(59508),k=t(52919),I=t(69498),M=t(67145);t(45020);V().locale(window.app.config.lang);var H=function(e){(0,o.Z)(t,e);var n=(0,r.Z)(t);function t(e){var s;return(0,i.Z)(this,t),(s=n.call(this,e)).onMouseEnter=function(){var e=s.props,n=e.currentVersion,t=e.historyVersion;n.commit_id!==t.commit_id&&s.setState({isShowOperationIcon:!0})},s.onMouseLeave=function(){var e=s.props,n=e.currentVersion,t=e.historyVersion;n.commit_id!==t.commit_id&&s.setState({isShowOperationIcon:!1})},s.onToggleClick=function(e){s.setState({isMenuShow:!s.state.isMenuShow})},s.onClick=function(){s.setState({isShowOperationIcon:!1});var e=s.props,n=e.currentVersion,t=e.historyVersion;n.commit_id!==t.commit_id&&s.props.onSelectHistoryVersion(t)},s.onRestore=function(){var e=s.props.historyVersion;s.props.onRestore(e)},s.onItemDownload=function(){},s.onItemCopy=function(){var e=s.props.historyVersion;e.ctime_format=V()(e.ctime).format("YYYY-MM-DD HH:mm"),s.props.onCopy(e)},s.toggleRename=function(){s.setState({isRenameShow:!s.state.isRenameShow})},s.onRenameConfirm=function(e){var n=s.props.historyVersion.obj_id;s.props.renameHistoryVersion(n,e),s.toggleRename()},s.onRenameCancel=function(){s.toggleRename()},s.state={isShowOperationIcon:!1,isMenuShow:!1,isRenameShow:!1},s}return(0,s.Z)(t,[{key:"render",value:function(){var e=this.props,n=e.currentVersion,t=e.historyVersion;if(!n||!t)return null;var i=t.ctime,s=t.commit_id,o=t.creator_name,r=t.obj_id,a=t.name,c=s===n.commit_id,l=I.Z.getUrl({type:"download_historic_file",filePath:m.bc,objID:r});return(0,p.jsxs)("li",{className:"history-list-item ".concat(c?"item-active":""),onMouseEnter:this.onMouseEnter,onMouseLeave:this.onMouseLeave,onClick:this.onClick,children:[(0,p.jsxs)("div",{className:"history-info",children:[this.state.isRenameShow?(0,p.jsx)(M.Z,{name:a,onRenameConfirm:this.onRenameConfirm,onRenameCancel:this.onRenameCancel}):(0,p.jsx)("div",{className:"name",children:a}),(0,p.jsx)("div",{className:"time",children:V()(i).format("YYYY-MM-DD HH:mm")}),(0,p.jsxs)("div",{className:"owner",children:[(0,p.jsx)("span",{className:"squire-icon"}),(0,p.jsx)("span",{children:o})]})]}),(0,p.jsx)("div",{className:"history-operation",children:(0,p.jsxs)(R.Z,{isOpen:this.state.isMenuShow,toggle:this.onToggleClick,children:[(0,p.jsx)(Z.Z,{tag:"a",className:"fas fa-ellipsis-v ".concat(this.state.isShowOperationIcon||c?"":"invisible"),"data-toggle":"dropdown","aria-expanded":this.state.isMenuShow,alt:(0,m.ih)("More Operations")}),(0,p.jsxs)(N.Z,{children:[(0,p.jsx)(k.Z,{tag:"a",href:l,onClick:this.onItemDownLoad,children:(0,m.ih)("Download")}),0!==this.props.index&&(0,p.jsx)(k.Z,{onClick:this.onItemCopy,children:(0,m.ih)("Copy")}),(0,p.jsx)(k.Z,{onClick:this.toggleRename,children:(0,m.ih)("Rename")})]})]})})]})}}]),t}(a.Component),_=t(57786),D=window.fileHistory.pageOptions.docUuid,L=function(e){(0,o.Z)(t,e);var n=(0,r.Z)(t);function t(e){var s;return(0,i.Z)(this,t),(s=n.call(this,e)).loadMore=function(){if(!s.state.isReloadingData){var e=s.state.currentPage+1;s.setState({currentPage:e,isReloadingData:!0}),f.I.listSdocHistory(D,e,m.LZ).then((function(e){s.updateResultState(e.data),s.setState({isReloadingData:!1})}))}},s.renameHistoryVersion=function(e,n){f.I.renameSdocHistory(D,e,n).then((function(t){s.setState({historyVersions:s.state.historyVersions.map((function(t){return t.obj_id==e&&(t.name=n),t}))})})).catch((function(e){var n=C.c.getErrorMsg(e,!0);s.setState({isLoading:!1,errorMessage:n})}))},s.onScrollHandler=function(e){var n=e.target.clientHeight,t=e.target.scrollHeight;n+e.target.scrollTop+1>=t&&s.state.hasMore&&s.loadMore()},s.restoreVersion=function(e){var n=e.commit_id,t=e.path;S.Z.revertFile(t,n).then((function(e){e.data.success&&(s.setState({isLoading:!0}),s.refershFileList());var n=(0,m.ih)("Successfully restored.");w.Z.success(n)})).catch((function(e){var n=C.c.getErrorMsg(e,!0);w.Z.danger((0,m.ih)(n))}))},s.onSelectHistoryVersion=function(e){if(s.props.isShowChanges){var n=s.state.historyVersions,t=n.findIndex((function(n){return n.commit_id===e.commit_id}));s.props.onSelectHistoryVersion(e,n[t+1])}else s.props.onSelectHistoryVersion(e)},s.copyHistoryFile=function(e){var n=e.path,t=e.obj_id,i=e.ctime_format;f.I.sdocCopyHistoryFile(m.y8,n,t,i).then((function(e){var n=(0,m.ih)("Successfully copied %(name)s."),t=e.data.file_name;n=n.replace("%(name)s",t),w.Z.success(n)})).catch((function(e){var n=C.c.getErrorMsg(e,!0);w.Z.danger((0,m.ih)(n))}))},s.renderHistoryVersions=function(){var e=s.state,n=e.isLoading,t=e.historyVersions,i=e.errorMessage;return 0===t.length?n?(0,p.jsx)("div",{className:"h-100 w-100 d-flex align-items-center justify-content-center",children:(0,p.jsx)(g.Z,{})}):i?(0,p.jsx)("div",{className:"h-100 w-100 d-flex align-items-center justify-content-center error-message",children:(0,m.ih)(i)}):(0,p.jsx)("div",{className:"h-100 w-100 d-flex align-items-center justify-content-center empty-tip-color",children:(0,m.ih)("No version history")}):(0,p.jsxs)(p.Fragment,{children:[t.map((function(e,n){return(0,p.jsx)(H,{index:n,currentVersion:s.props.currentVersion,historyVersion:e,onSelectHistoryVersion:s.onSelectHistoryVersion,onRestore:s.restoreVersion,onCopy:s.copyHistoryFile,renameHistoryVersion:s.renameHistoryVersion},e.commit_id)})),n&&(0,p.jsx)("div",{className:"loading-more d-flex align-items-center justify-content-center w-100",children:(0,p.jsx)(g.Z,{})})]})},s.onShowChanges=function(){var e=s.props,n=e.isShowChanges,t=e.currentVersion,i=s.state.historyVersions,o=i.findIndex((function(e){return e.commit_id===t.commit_id})),r=i[o+1];s.props.onShowChanges(!n,r)},s.state={isLoading:!0,historyVersions:[],errorMessage:"",currentPage:1,hasMore:!1,fileOwner:"",isReloadingData:!1},s}return(0,s.Z)(t,[{key:"componentDidMount",value:function(){var e=this;f.I.listSdocHistory(D,1,m.LZ).then((function(n){if(0===n.data.length)throw e.setState({isLoading:!1}),Error("there has an error in server");e.initResultState(n.data)}))}},{key:"refershFileList",value:function(){var e=this;f.I.listSdocHistory(D,1,m.LZ).then((function(n){e.initResultState(n.data)}))}},{key:"initResultState",value:function(e){e.histories.length&&(this.setState({historyVersions:e.histories,currentPage:e.page,hasMore:e.total_count>m.LZ*this.state.currentPage,isLoading:!1,fileOwner:e.histories[0].creator_email}),this.props.onSelectHistoryVersion(e.histories[0],e.histories[1]))}},{key:"updateResultState",value:function(e){e.histories.length&&this.setState({historyVersions:[].concat((0,x.Z)(this.state.historyVersions),(0,x.Z)(e.histories)),currentPage:e.page,hasMore:e.total_count>m.LZ*this.state.currentPage,isLoading:!1,fileOwner:e.histories[0].creator_email})}},{key:"render",value:function(){var e=this.state.historyVersions;return(0,p.jsxs)("div",{className:"sdoc-file-history-panel h-100 o-hidden d-flex flex-column",children:[(0,p.jsx)("div",{className:"sdoc-file-history-select-range",children:(0,p.jsx)("div",{className:"sdoc-file-history-select-range-title",children:(0,m.ih)("History Versions")})}),(0,p.jsx)("div",{className:d()("sdoc-file-history-versions",{"o-hidden":0===e.length}),onScroll:this.onScrollHandler,children:this.renderHistoryVersions()}),(0,p.jsx)("div",{className:"sdoc-file-history-diff-switch d-flex align-items-center",children:(0,p.jsx)(_.Z,{checked:this.props.isShowChanges,placeholder:(0,m.ih)("Show changes"),className:"sdoc-history-show-changes w-100",size:"small",onChange:this.onShowChanges})})]})}}]),t}(a.Component),b=(t(28421),window.app.config),E=b.serviceURL,O=b.avatarURL,F=b.siteRoot,P=window.app.pageOptions,T=P.username,U=P.name,Y=window.fileHistory.pageOptions,q=Y.repoID,B=Y.fileName,K=Y.filePath,A=Y.docUuid,z=Y.assetsUrl;window.seafile={repoID:q,docPath:K,docName:B,docUuid:A,isOpenSocket:!1,serviceUrl:E,name:U,username:T,avatarURL:O,siteRoot:F,assetsUrl:z};var W=function(e){(0,o.Z)(t,e);var n=(0,r.Z)(t);function t(e){var s;(0,i.Z)(this,t),(s=n.call(this,e)).onSelectHistoryVersion=function(e,n){s.setState({isLoading:!0,currentVersion:e}),f.I.getFileRevision(m.y8,e.commit_id,e.path).then((function(e){return f.I.getFileContent(e.data)})).then((function(e){var t=e.data;n?f.I.getFileRevision(m.y8,n.commit_id,n.path).then((function(e){return f.I.getFileContent(e.data)})).then((function(e){var n=e.data;s.setContent(t,n)})).catch((function(e){var n=C.c.getErrorMsg(e,!0);w.Z.danger((0,m.ih)(n)),s.setContent(t,"")})):s.setContent(t,"")})).catch((function(e){var n=C.c.getErrorMsg(e,!0);w.Z.danger((0,m.ih)(n)),s.setContent("","")}))},s.setContent=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";s.setState({currentVersionContent:e,lastVersionContent:n,isLoading:!1,changes:[],currentDiffIndex:0})},s.onShowChanges=function(e,n){if(e&&n){var t=s.state.currentVersionContent;s.setState({isLoading:!0},(function(){localStorage.setItem("seahub-sdoc-history-show-changes",e+""),f.I.getFileRevision(m.y8,n.commit_id,n.path).then((function(e){return f.I.getFileContent(e.data)})).then((function(n){var i=n.data;s.setContent(t,i),s.setState({isShowChanges:e})})).catch((function(n){var i=C.c.getErrorMsg(n,!0);w.Z.danger((0,m.ih)(i)),s.setContent(t,""),s.setState({isShowChanges:e})}))}))}else s.setState({isShowChanges:e},(function(){localStorage.setItem("seahub-sdoc-history-show-changes",e+"")}))},s.setDiffCount=function(){var e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{value:[],changes:[]}).changes;s.setState({changes:e,currentDiffIndex:0})},s.jumpToElement=function(e){s.setState({currentDiffIndex:e},(function(){var e=s.state,n=e.currentDiffIndex,t=e.changes[n],i=document.querySelectorAll("[data-id=".concat(t,"]"))[0];i&&(s.historyContentRef.scrollTop=i.offsetTop-10)}))},s.lastChange=function(){var e=s.state,n=e.currentDiffIndex,t=e.changes;0!==n?s.jumpToElement(n-1):s.jumpToElement(t.length-1)},s.nextChange=function(){var e=s.state,n=e.currentDiffIndex;n!==e.changes.length-1?s.jumpToElement(n+1):s.jumpToElement(0)},s.renderChangesTip=function(){var e=s.state,n=e.isShowChanges,t=e.changes,i=e.currentDiffIndex;if(e.isLoading)return null;if(!n)return null;var o=t?t.length:0;return 0===o?(0,p.jsx)("div",{className:"sdoc-file-history-header-right d-flex align-items-center",children:(0,p.jsx)("div",{className:"sdoc-file-changes-container d-flex align-items-center pl-2 pr-2",children:(0,m.ih)("No changes")})}):(0,p.jsx)("div",{className:"sdoc-file-history-header-right d-flex align-items-center",children:(0,p.jsxs)("div",{className:"sdoc-file-changes-container d-flex align-items-center",children:[(0,p.jsx)("div",{className:"sdoc-file-changes-tip d-flex align-items-center justify-content-center pl-2 pr-2",children:"".concat((0,m.ih)("Changes")," ").concat(i+1,"/").concat(o)}),(0,p.jsx)("div",{className:"sdoc-file-changes-divider"}),(0,p.jsx)("div",{className:"sdoc-file-changes-last d-flex align-items-center justify-content-center",id:"sdoc-file-changes-last",onClick:s.lastChange,children:(0,p.jsx)("span",{className:"fas fa-chevron-up"})}),(0,p.jsx)("div",{className:"sdoc-file-changes-divider"}),(0,p.jsx)("div",{className:"sdoc-file-changes-next d-flex align-items-center justify-content-center",id:"sdoc-file-changes-next",onClick:s.nextChange,children:(0,p.jsx)("span",{className:"fas fa-chevron-down"})}),(0,p.jsx)(l.Z,{placement:"bottom",target:"sdoc-file-changes-last",children:(0,m.ih)("Last modification")}),(0,p.jsx)(l.Z,{placement:"bottom",target:"sdoc-file-changes-next",children:(0,m.ih)("Next modification")})]})})};var o="false"!==localStorage.getItem("seahub-sdoc-history-show-changes");return s.state={isLoading:!0,isShowChanges:o,currentVersion:{},currentVersionContent:"",lastVersionContent:"",changes:[],currentDiffIndex:0},s}return(0,s.Z)(t,[{key:"render",value:function(){var e=this,n=this.state,t=n.currentVersion,i=n.isShowChanges,s=n.currentVersionContent,o=n.lastVersionContent,r=n.isLoading;return(0,p.jsxs)("div",{className:"sdoc-file-history d-flex h-100 w-100 o-hidden",children:[(0,p.jsxs)("div",{className:"sdoc-file-history-container d-flex flex-column",children:[(0,p.jsxs)("div",{className:"sdoc-file-history-header pt-2 pb-2 pl-4 pr-4 d-flex justify-content-between w-100 o-hidden",children:[(0,p.jsxs)("div",{className:d()("sdoc-file-history-header-left d-flex align-items-center o-hidden",{"pr-4":i}),children:[(0,p.jsx)(y,{}),(0,p.jsx)("div",{className:"file-name text-truncate",children:B})]}),this.renderChangesTip()]}),(0,p.jsx)("div",{className:"sdoc-file-history-content f-flex flex-column",ref:function(n){return e.historyContentRef=n},children:r?(0,p.jsx)("div",{className:"sdoc-file-history-viewer d-flex align-items-center justify-content-center",children:(0,p.jsx)(g.Z,{})}):(0,p.jsx)(u.ZX,{currentContent:s,lastContent:i?o:"",didMountCallback:this.setDiffCount})})]}),(0,p.jsx)(L,{isShowChanges:i,currentVersion:t,onSelectHistoryVersion:this.onSelectHistoryVersion,onShowChanges:this.onShowChanges})]})}}]),t}(a.Component);c.render((0,p.jsx)(W,{}),document.getElementById("wrapper"))},45020:function(){}},function(e){e.O(0,[351],(function(){return n=39321,e(e.s=n);var n}));e.O()}]);
//# sourceMappingURL=sdocFileHistory.1681a28c.js.map